# Better Auth Initialization & Configuration

## Overview
- Initialize Better Auth server configuration with database adapter, email/password authentication, and social OAuth providers
- Establish authentication foundation for user registration, login, and session management
- Configure secure JWT handling, email verification, and multi-provider authentication options
- Feature type: Technical Integration

## Requirements

### Service Details
- Better Auth v1.0+ server package for authentication logic
- **Prisma ORM** as database adapter connecting to `soloai_db` (from DB02-Prisma-Setup.md)
- MySQL database container from DB01-DB-Container-Setup.md
- Email provider integration for verification and password reset flows
- Social OAuth providers: Google, GitHub, Discord for streamlined registration

### Authentication Methods
- Email/password authentication with secure password hashing (Argon2)
- Social login support with OAuth 2.0 flow handling
- Email verification workflow for new user accounts
- Password reset functionality with secure token generation

### Security Configuration
- JWT secret management using BETTER_AUTH_SECRET environment variable
- Session handling with secure cookie configuration and CSRF protection
- Rate limiting for authentication attempts and password reset requests
- Input validation and sanitization for all authentication fields

### Database Integration
- Connect to `soloai_db` database via Prisma Client (from DB02-Prisma-Setup.md)
- Better Auth auto-generates authentication tables via Prisma schema:
  - `user`: User accounts with id, email, name, emailVerified, image, timestamps
  - `session`: Active user sessions with expiration handling
  - `account`: OAuth provider connections (Google, GitHub, Discord)
  - `verification`: Email verification and password reset tokens
- Prisma migrations track all schema changes
- Type-safe database access via Prisma Client for all auth operations

## Technical Specifications

### Dependencies
- better-auth (server package) - installed in AU01-Install-BetterAuth.md
- **Prisma ORM** (@prisma/client and prisma) - configured in DB02-Prisma-Setup.md
- **Prisma adapter** from `better-auth/adapters/prisma` - connects Better Auth to Prisma ORM
- **Better Auth CLI** (@better-auth/cli) - for schema generation and migrations
- Email provider SDK (nodemailer, resend, or similar)
- OAuth provider SDKs for social authentication
- Crypto utilities for secure token generation

### Database Changes
- Authentication tables auto-generated by Better Auth
- User table with id, email, name, emailVerified, image, createdAt, updatedAt
- Session table for active user sessions with expiration handling
- Account table for OAuth provider connections
- Verification token table for email verification and password reset

### Environment Variables Required

**Server-Side (Private)**:
- `BETTER_AUTH_SECRET` - 32+ character cryptographically secure string for JWT signing
- `GOOGLE_ID`, `GOOGLE_SECRET` - Google OAuth credentials
- `GITHUB_CLIENT_ID`, `GITHUB_CLIENT_SECRET` - GitHub OAuth credentials
- `EMAIL_FROM`, `EMAIL_SERVER_HOST`, `EMAIL_SERVER_PORT`, `EMAIL_SERVER_USER`, `EMAIL_SERVER_PASSWORD` - Email service config

**Client-Side (Public)**:
- `PUBLIC_BASE_URL` - Base URL for authentication callbacks and API endpoints (e.g., `http://localhost:5173` or `https://yourdomain.com`)

### Configuration Requirements
- Create `src/lib/auth.ts` or `src/auth.ts` file with Better Auth initialization
- Configure Prisma adapter using `prismaAdapter(prisma, { provider: "mysql" })` syntax
- Import PrismaClient instance from DB02-Prisma-Setup.md configuration
- **Important**: Specify correct database provider in adapter config (e.g., "mysql", "postgresql", "sqlite")
- **Schema Generation**: Run `npx @better-auth/cli@latest generate` to create auth tables in Prisma schema
- **Migration**: After schema generation, run `npx prisma migrate dev` to apply database changes
- Set up email provider configuration for verification and password reset emails
- Configure OAuth providers with proper redirect URLs and scopes
- Implement session management with appropriate expiration and refresh handling
- Enable email verification requirement for new user accounts
- Configure password requirements (minimum length, complexity)
- Set up proper error handling and logging for authentication events

### Configuration Example from Solo AI Reference Project

**File**: `src/auth.ts`

```typescript
import { betterAuth } from "better-auth";
import { prismaAdapter } from "better-auth/adapters/prisma";
import { sveltekitCookies } from "better-auth/svelte-kit";
import { PrismaClient } from "@prisma/client";
import { GOOGLE_ID, GOOGLE_SECRET } from "$env/static/private";
import { PUBLIC_BASE_URL } from "$env/static/public";
import { getRequestEvent } from "$app/server";

const prisma = new PrismaClient();

export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "mysql" // Must match your database type
  }),
  baseURL: PUBLIC_BASE_URL,
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: false
  },
  socialProviders: {
    google: {
      clientId: GOOGLE_ID as string,
      clientSecret: GOOGLE_SECRET as string,
    },
  },
  user: {
    additionalFields: {
      locale: {
        type: "string",
        required: false,
        defaultValue: "en",
      },
      timezone: {
        type: "string",
        required: false,
        defaultValue: "UTC",
      }
    }
  },
  databaseHooks: {
    user: {
      create: {
        before: async (user, ctx) => {
          // Get locale from Paraglide if not set
          const event = getRequestEvent();
          if (!user.locale && event) {
            const paraglideCookieLocale = event.cookies.get('PARAGLIDE_LOCALE');
            const paraglideEventLocale = event.locals?.paraglide?.locale;
            user.locale = paraglideEventLocale || paraglideCookieLocale || "en";
          }
          if (!user.timezone && event) {
            const preferredTimezone = event.cookies.get('preferredTimezone');
            user.timezone = preferredTimezone || "UTC";
          }
          return { data: user };
        }
      }
    }
  },
  plugins: [
    // sveltekitCookies plugin ensures proper cookie handling in server actions
    // This should be the last plugin as per Better Auth docs
    sveltekitCookies(getRequestEvent)
  ]
});
```

**Key Configuration Points**:
- **Prisma Adapter**: Uses `prismaAdapter(prisma, { provider: "mysql" })` for MySQL database
- **Base URL**: Set via `PUBLIC_BASE_URL` environment variable for OAuth callbacks
- **Authentication Methods**: Email/password enabled with optional email verification
- **Social Providers**: Google OAuth configured (add more providers as needed)
- **Custom User Fields**: Adds `locale` and `timezone` for internationalization support
- **Database Hooks**: Pre-populates user locale and timezone from cookies on registration
- **Plugins**: `sveltekitCookies` plugin ensures cookies work in server actions (place last)

**Note**: If using a custom Prisma output directory in your `schema.prisma` file, import PrismaClient from that custom location instead of `@prisma/client`.

### Integration Points
- Database connection via Prisma to `soloai_db` in MySQL container (DB02-Prisma-Setup.md)
- Better Auth auto-generates Prisma models for auth tables via CLI
- Email configuration must support future Mautic integration workflow
- User data structure must accommodate future profile management features
- Authentication configuration must support future route protection implementation
- Session handling must integrate with SvelteKit's server-side rendering
- Type-safe database queries via Prisma Client for all auth operations

### Security Considerations
- JWT secrets must be cryptographically secure and environment-specific
- Session cookies must be httpOnly, secure, and sameSite protected
- OAuth redirect URLs must be validated and restricted to application domains
- Password hashing must use Argon2 or equivalent secure algorithm
- Rate limiting must prevent brute force attacks on authentication endpoints
- Email verification tokens must have appropriate expiration and single-use enforcement

## Prerequisites
- DB01-DB-Container-Setup.md (MySQL database container)
- **DB02-Prisma-Setup.md (Prisma ORM and soloai_db database configuration)**
- AU01-Install-BetterAuth.md (Better Auth packages and environment variables)
- EV01-Env-File-Setup.md (environment variable management)
- EV02-Env-Validation.md (environment variable validation)

## Success Criteria
- Better Auth server successfully initializes with all configured providers
- Database tables are automatically created and accessible
- Email verification workflow functions correctly
- Social OAuth providers successfully authenticate test users
- JWT tokens are properly signed and validated
- Authentication configuration supports all planned authentication flows
- No authentication secrets are exposed in client-side code or logs